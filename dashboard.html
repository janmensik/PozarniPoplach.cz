<!DOCTYPE html>
<html lang="cs">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous" />

    <title>Požární poplach</title>
    <link rel="icon" href="./favicon.svg" type="image/svg+xml" />
    <style>
      .bg-black h3.h6.text-muted,
      .bg-black small.text-muted,
      .bg-black p.h5 .text-muted {
        color: #999 !important;
      }
      .scrollable-col {
        overflow-y: auto;
      }
      @keyframes pulse-indicator {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      #other-units .list-group-item {
        border-color:#595c5f;
      }
    </style>
  </head>
  <body class="d-flex flex-column vh-100">
    <div class="container-fluid bg-danger d-flex justify-content-between align-items-center">
      <h2 class="display-6 text-white pb-0 mb-0">Libčice nad Vltavou</h2>
      <div class="d-flex align-items-center">
        <div id="refresh-indicator" class="h4 text-white me-2" style="display: none; animation: pulse-indicator 1.5s ease-in-out infinite;">●</div>
        <div id="clock" class="text-white text-muted font-monospace"></div>
      </div>
    </div>
    <div class="container-fluid p-0 flex-grow-1">
      <div class="row g-0 h-100">
        <div class="col-4 p-3 bg-black text-white scrollable-col">
          <div class="d-flex flex-column h-100">
            <h1 class="alert alert-warning fw-bolder h4" role="alert">
              <i class="fa-solid fa-fire fa-fade"></i>
              POŽÁR - NÍZKÉ BUDOVY
            </h1>

            <div class="card bg-dark text-white">
              <div class="card-body">
                <div>
                  <h3 class="h6 text-muted">Adresa události:</h3>
                  <address class="h5">
                    <strong class="text-warning">LETECKÁ 522</strong><br />
                    LIBČICE NAD VLTAVOU <small>(část: Libčice nad Vltavou)</small>
                  </address>
                </div>
                <hr />
                <div>
                  <h3 class="h6 text-muted">OBJEKT:</h3>
                  <p class="h5"></p>
                </div>
                <hr />
                <div>
                  <h3 class="h6 text-muted">UPŘESNĚNÍ:</h3>
                  <p class="h5"></p>
                </div>
                <hr />
                <div>
                  <h3 class="h6 text-muted">CO SE STALO:</h3>
                  <p class="h5">hoří v baraku - jedná se o BD 2 poschodí</p>
                </div>
                <hr />
                <div>
                  <h3 class="h6 text-muted">OZNÁMENÍ:</h3>
                  <p class="h5"></p>
                  <p class="h5"><small class="text-muted">Telefon:</small> 0608840315</p>
                </div>
              </div>
            </div>

            <!-- <div class="card my-3">
              <div class="card-header">
                <h5 class="card-title h6 text-muted">Oznámení (oznamovatel):</h5>
              </div>
              <div class="card-body">
                <p class="card-text"></p>
                <h6 class="card-subtitle mb-2 text-muted">Telefon:</h6>
                <p class="card-text">0608840315</p>
              </div>
            </div> -->

            <div class="card bg-dark text-white mt-3" id="other-units">
              <div class="card-body">
                <h3 class="h6 text-muted">TECHNIKA dalších jednotek PO:</h3>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item bg-dark text-white px-0 small">HS Roztoky: CAS 20/4000/240 S2T SCANIA - PPZ 121</li>
                  <li class="list-group-item bg-dark text-white px-0 small">CHS Kladno: VEA L2 FORD RANGER - PKL 115</li>
                  <li class="list-group-item bg-dark text-white px-0 small">HS Roztoky: CAS 30/8000/800 S1LP SCANIA - PPZ 122</li>
                </ul>
              </div>
            </div>

            <div class="mt-3">
              <small class="text-muted"><i>Událost č. 2891212021 - odbavil Pracoviště 5 OD - 19.08.2025 17:02:59</i></small>
            </div>

            <div class="card mt-auto text-center bg-success bg-gradient text-white" id="timer" data-timer-start="2025-08-31T11:33:45+02:00" data-timer-limit="600">
              <div class="card-header">
                <h5 class="card-title h6 text-muted">Odpočet:</h5>
              </div>
              <div class="card-body">
                <p class="card-text h1 fw-bold font-monospace" id="time">00:00</p>
              </div>
            </div>


          </div>
        </div>
        <div class="col-8 text-end scrollable-col">
          <div class="position-relative">
            <img src="https://maps.googleapis.com/maps/api/staticmap?size=640x405&scale=2&path=color:0x0000ff|weight:5|enc:cskqHkwsvAc@RHeACaBOiCI_ALYNOdBs@NQ`@cA`CyFx@{A\KXBFDnAyFz@_Ep@cCXq@bAgBjAaBAq@JoBE[MWbAgB`@KZB&markers=color:red|50.195343,14.370878&key=AIzaSyCXuUObt494VAynzGa4Qr85Zocv6xsGcoY" class="img-fluid w-100" id="map" alt="Mapa s požárními body" />
            <div class="position-absolute bottom-0 start-0 end-0 bg-dark bg-opacity-75 text-white p-2 text-center">
              <p class="mb-0"><strong>Adresa:</strong> LETECKÁ 522, LIBČICE NAD VLTAVOU | <strong>Vzdálenost:</strong> 1&nbsp;km | <strong>Doba jízdy:</strong> 3 min</p>
            </div>
          </div>
          <div class="row m-0">
            <div class="col-8 pt-3">
              <div class="row justify-content-start" id="vehicles">
                <div class="col">
                  <div class="card text-center shadow-sm h-100" style="max-width: 10em">
                    <div class="card-header h5 bg-warning"><strong>HPZ 412</strong></div>
                    <div class="card-body p-1">
                      <i class="fa-solid fa-truck-fire fa-4x text-muted"></i>
                      <p class="card-text p-2">CAS 25/2500/0 M2R LIAZ 101</p>
                    </div>
                  </div>
                </div>
                <div class="col">
                  <div class="card text-center shadow-sm h-100" style="max-width: 10em">
                    <div class="card-header h5 bg-warning"><strong>HPZ 411</strong></div>
                    <div class="card-body p-1">
                      <i class="fa-solid fa-truck-fire fa-4x text-muted"></i>
                      <p class="card-text p-2">CAS 25/3500/0 Skoda RT</p>
                    </div>
                  </div>
                </div>
                <div class="col">
                  <div class="card text-center shadow-sm h-100" style="max-width: 10em">
                    <div class="card-header h5 bg-warning"><strong>HPZ 414</strong></div>
                    <div class="card-body p-1">
                      <i class="fa-solid fa-van-shuttle fa-4x text-muted"></i>
                      <p class="card-text p-2">DA VW Transit</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-4 pe-0">
              <img src="https://api.mapbox.com/styles/v1/mapbox/satellite-streets-v12/static/pin-s+e44b38(14.3709,50.1953)/14.370878,50.195343,17,0/500x280@2x?access_token=pk.eyJ1IjoiamFubWVuc2lrIiwiYSI6ImNtZXppeHZpYTFrM3Aya3NkaDV0aWt2a3gifQ.Ye6eOACnKC2xgWAE8mNASA" alt="Detailní pohled na místo události" class="img-fluid" />
              <!-- <img src="https://maps.googleapis.com/maps/api/staticmap?size=404x202&scale=2&zoom=17&markers=color:red|50.195343,14.370878&maptype=hybrid&key=AIzaSyCXuUObt494VAynzGa4Qr85Zocv6xsGcoY" class="img-fluid" /> -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <script src="https://kit.fontawesome.com/3208d26f35.js" crossorigin="anonymous"></script>

    <!-- Audio element for the alarm sound -->
    <audio id="alarm-sound-start" src="./timer-start.mp3" preload="auto"></audio>
    <audio id="alarm-sound-limit" src="./timer-limit.mp3" preload="auto"></audio>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
        let timerIntervalId = null; // To hold the ID of the timer interval
        let limitSoundHasPlayed = false; // Flag to ensure limit sound plays only once per event
        let lastTimerStartValue = null; // To track the current event

        /**
         * Initializes and runs the countdown timer.
         * Finds all necessary elements and sets up the per-second update.
         */
        function initializeTimer() {
          const timerElement = document.getElementById('timer');
          const timeDisplay = document.getElementById('time');
          const alarmSoundStart = document.getElementById('alarm-sound-start');
          const alarmSoundLimit = document.getElementById('alarm-sound-limit');

          if (!timerElement || !timeDisplay) return;

          // Check if it's a new event by comparing timer start time
          const currentTimerStart = timerElement.dataset.timerStart;
          if (lastTimerStartValue !== currentTimerStart) {
            limitSoundHasPlayed = false; // Reset the flag for the new event
            lastTimerStartValue = currentTimerStart;
          }

          const startTime = new Date(timerElement.dataset.timerStart);
          const timerLimit = parseInt(timerElement.dataset.timerLimit, 10);
          let limitExceeded = false;
          let startSoundPlayed = false;

          if (isNaN(startTime.getTime())) {
            timeDisplay.textContent = 'Error';
            return;
          }

          const playSound = (soundElement) => {
            if (soundElement) {
              soundElement.play().catch(error => console.error("Audio playback failed:", error));
            }
          };

          const updateTimer = () => {
            const elapsedSeconds = Math.floor((new Date() - startTime) / 1000);

            if (elapsedSeconds < 0) {
              timeDisplay.textContent = '00:00';
              return;
            }

            if (!startSoundPlayed && elapsedSeconds < 11) {
              playSound(alarmSoundStart);
              startSoundPlayed = true;
            }

            const minutes = Math.floor(elapsedSeconds / 60);
            const seconds = elapsedSeconds % 60;
            timeDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

            if (!limitExceeded && !isNaN(timerLimit) && elapsedSeconds > timerLimit) {
              timerElement.classList.remove('bg-success');
              timerElement.classList.add('bg-danger');
              limitExceeded = true;
              if (!limitSoundHasPlayed) {
                playSound(alarmSoundLimit);
                limitSoundHasPlayed = true;
              }
            }
          };

          updateTimer();
          timerIntervalId = setInterval(updateTimer, 1000);
        }

        /**
         * Fetches the latest version of the page in the background and
         * swaps the content without a full page reload.
         */
        async function refreshContentSeamlessly() {
          const indicator = document.getElementById('refresh-indicator');

          const hideIndicator = () => {
            if (indicator) {
              setTimeout(() => {
                indicator.style.display = 'none';
              }, 500); // Keep visible for 0.5s after refresh
            }
          };

          try {
            const response = await fetch(window.location.href, { cache: 'no-store' });
            if (!response.ok) {
              // Don't show indicator if fetch was not successful
              return;
            }

            // Show indicator only on successful fetch
            if (indicator) {
              indicator.style.display = 'block';
            }

            const htmlText = await response.text();
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(htmlText, 'text/html');
            const currentContent = document.querySelector('.row.g-0.h-100');
            const newContent = newDoc.querySelector('.row.g-0.h-100');
            if (currentContent && newContent) {
              clearInterval(timerIntervalId); // Stop the old timer
              currentContent.innerHTML = newContent.innerHTML; // Swap content
              initializeTimer(); // Start a new timer with the new elements
            }
            hideIndicator();
          } catch (error) {
            console.error('Seamless refresh failed, falling back to hard reload.', error);
            window.location.reload(); // Fallback to a hard reload on error
          }
        }

        /**
         * Updates the clock in the header every second.
         */
        function updateClock() {
          const clockElement = document.getElementById('clock');
          if (!clockElement) return;

          const now = new Date();
          // Use cs-CZ locale for correct date and time formatting
          const date = now.toLocaleDateString('cs-CZ');
          const time = now.toLocaleTimeString('cs-CZ');

          clockElement.textContent = `${date} ${time}`;
        }

        // Start the timer on initial page load
        initializeTimer();

        updateClock();
        setInterval(updateClock, 1000);
        // Set up the seamless refresh to run every 10 seconds
        setInterval(refreshContentSeamlessly, 10000);
      });
    </script>
  </body>
</html>
